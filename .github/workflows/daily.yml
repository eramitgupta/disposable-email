name: Merge Disposable Email Blocklist

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: 

jobs:
  main:
    runs-on: ubuntu-latest
    permissions:                
      contents: write           

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # Updated to v4

    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

    - name: Download domains list
      run: |
        mkdir -p sources
        curl -fsS -o sources/stopforumspam_domains.txt https://www.stopforumspam.com/downloads/toxic_domains_whole.txt || echo "stopforumspam download failed"
        curl -fsS -o sources/disposable_email_blocklist.txt https://raw.githubusercontent.com/disposable-email-domains/disposable-email-domains/master/disposable_email_blocklist.conf || echo "blocklist 1 download failed"
        curl -fsS -o sources/disposable_email_blocklist-2.txt https://disposable.github.io/disposable-email-domains/domains.txt || echo "blocklist 2 download failed"
        curl -fsS -o sources/disposable_email_blocklist-3.txt https://raw.githubusercontent.com/disposable/disposable-email-domains/master/domains.txt || echo "blocklist 3 download failed"

    - name: Merge and process files
      run: |
        # Merge all source files into a temporary file
        cat sources/*.txt > temp_blocklist.txt
        # Remove duplicates and create final file
        sort temp_blocklist.txt | uniq > disposable_email.txt
        # Clean up temporary file
        rm temp_blocklist.txt

    - name: Check for changes and commit
      run: |
        # Add the final file to staging
        git add disposable_email.txt
        
        # Check if there are staged changes
        if git diff --cached --quiet; then
          echo "No changes to commit"
          echo "CHANGES_EXIST=false" >> $GITHUB_ENV
        else
          echo "Changes detected, committing..."
          git commit -m "chore: update disposable email blocklist $(date +'%Y-%m-%d')"
          echo "CHANGES_EXIST=true" >> $GITHUB_ENV
        fi

    - name: Push changes
      if: env.CHANGES_EXIST == 'true'
      uses: ad-m/github-push-action@v0.8.0  # Updated to latest version
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

    - name: Clean up sources directory
      run: |
        # Remove the sources directory to keep repository clean
        rm -rf sources
